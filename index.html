<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV → Webex API Runner</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root { --bg:#0b1020; --card:#131a2a; --muted:#92a0b8; --fg:#e9edf5; --accent:#7dd3fc; --warn:#fbbf24; --err:#f87171; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg,#0b1020,#0a132a); color:var(--fg); }
    .wrap { max-width:1400px; margin:0 auto; padding:32px 20px 80px; }
    .header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
    .title { font-size:clamp(24px,3vw,38px); font-weight:800; letter-spacing:.2px; }
    .sub { color:var(--muted); }
    .logo { height:40px; }
    .grid { display:grid; grid-template-columns:2fr 1fr; gap:20px; }
    .card { background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    label { display:block; font-size:13px; color:var(--muted); margin:8px 0 6px; }
    input, select, textarea { width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0e1525; color:var(--fg); padding:10px 12px; outline:none; font-size:14px; }
    input[type="file"]{ padding:8px; }
    .row { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .btn { background:linear-gradient(135deg,#22d3ee,#3b82f6); border:none; color:#06111d; font-weight:700; padding:10px 18px; border-radius:12px; cursor:pointer; }
    .btn.secondary { background:#0e1525; color:var(--fg); border:1px solid rgba(255,255,255,.1); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:12px; color:var(--muted); }
    .progress { height:10px; background:#0e1525; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
    .bar { height:100%; background:linear-gradient(90deg,#22d3ee,#3b82f6); width:0%; transition:width .25s ease; }
    .log { height:280px; overflow:auto; background:#0e1525; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:13px; white-space:pre-wrap; }
    .danger { color:var(--err); }
    .warn { color:var(--warn); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">CSV → Webex API Runner</div>
        <div class="sub">Upload a CSV, pick an action, and we’ll call <code>https://webexapis.com</code> with your Bearer token.</div>
      </div>
      <img src="CX%20Advanced%20Solutions_Smaller_white.png" alt="Logo" class="logo" />
    </div>

    <div class="grid">
      <div class="card">
        <label>API Action</label>
        <select id="apiSelect">
          <option value="create_workspaces" selected>Create Workspaces</option>
        </select>

        <label>Bearer Token</label>
        <input id="token" type="password" placeholder="Paste your Bearer token" autocomplete="off" />
        <div class="hint">Token is not saved; it lives only while the page is open.</div>

        <div class="row">
          <div style="flex:2;">
            <label>CSV</label>
            <input id="csvFile" type="file" accept=".csv" />
          </div>
          <div style="flex:1; min-width:140px;">
            <label>Concurrency</label>
            <input id="concurrency" type="number" min="1" max="16" value="4" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <label class="row" style="gap:8px;align-items:center;">
            <input id="dryRun" type="checkbox" checked>
            <span>Dry-run (parse & validate only)</span>
          </label>
          <label class="row" style="gap:8px;align-items:center;">
            <input id="stopOnError" type="checkbox">
            <span>Stop on first error</span>
          </label>
        </div>

        <div class="row" style="margin-top:16px;flex-wrap:wrap;">
          <button id="runBtn" class="btn">Run</button>
          <button id="cancelBtn" class="btn secondary" disabled>Cancel</button>
          <button id="downloadErrorsBtn" class="btn secondary" disabled>Download errors CSV</button>
        </div>

        <div style="margin-top:18px;">
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div id="status" class="hint" style="margin-top:8px;">Idle</div>
        </div>
      </div>

      <div class="card">
        <label>Console</label>
        <div id="log" class="log" aria-live="polite"></div>
      </div>
    </div>
  </div>

<script>
(function() {
  const els = {
    apiSelect: document.getElementById('apiSelect'),
    token: document.getElementById('token'),
    csvFile: document.getElementById('csvFile'),
    concurrency: document.getElementById('concurrency'),
    dryRun: document.getElementById('dryRun'),
    stopOnError: document.getElementById('stopOnError'),
    runBtn: document.getElementById('runBtn'),
    cancelBtn: document.getElementById('cancelBtn'),
    downloadErrorsBtn: document.getElementById('downloadErrorsBtn'),
    bar: document.getElementById('bar'),
    status: document.getElementById('status'),
    log: document.getElementById('log'),
  };

  const BASE_URL = 'https://webexapis.com';
  const ACTIONS = { create_workspaces: { endpoint: '/v1/workspaces', method: 'POST' } };

  function log(msg, type) {
    const line = document.createElement('div');
    if (type === 'error') line.classList.add('danger');
    if (type === 'warn') line.classList.add('warn');
    line.textContent = msg;
    els.log.appendChild(line);
    els.log.scrollTop = els.log.scrollHeight;
  }

  function setProgress(done, total) {
    const pct = total ? Math.round((done/total) * 100) : 0;
    els.bar.style.width = pct + '%';
    els.status.textContent = `${done}/${total} (${pct}%)`;
  }

  function downloadCSV(rows, name = 'errors.csv') {
    if (!rows.length) return;
    const headers = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
    const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? '').replace(/^\"|\"$/g,'')).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
  }

  async function sendRow({row, idx, cfg}) {
    const { endpoint, method, token } = cfg;
    const url = BASE_URL + endpoint;
    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    const body = JSON.stringify(row);

    const res = await fetch(url, { method, headers, body });
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
    return text;
  }

  async function run() {
    let errors = [];
    els.runBtn.disabled = true;
    els.cancelBtn.disabled = false;
    els.downloadErrorsBtn.disabled = true;
    els.log.textContent = '';
    setProgress(0, 0);

    try {
      const action = ACTIONS[els.apiSelect.value];
      const token = els.token.value.trim();
      if (!token && !els.dryRun.checked) throw new Error('Bearer token required.');
      const file = els.csvFile.files?.[0];
      if (!file) throw new Error('Please select a CSV file.');

      const rows = await new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data),
          error: (err) => reject(err),
        });
      });

      const total = rows.length;
      log(`Parsed ${total} rows.`);
      setProgress(0, total);

      if (els.dryRun.checked) {
        log('Dry-run only; no network calls made.', 'warn');
        setProgress(total, total);
        els.runBtn.disabled = false;
        els.cancelBtn.disabled = true;
        return;
      }

      let done = 0;
      for (let i = 0; i < rows.length; i++) {
        try {
          await sendRow({ row: rows[i], idx: i, cfg: { ...action, token } });
          log(`Row ${i+1}: ✓ success`);
        } catch (e) {
          log(`Row ${i+1}: ✗ ${e.message}`, 'error');
          errors.push({ row: i+1, error: e.message, ...rows[i] });
        }
        done++; setProgress(done, total);
      }

      if (errors.length) {
        log(`Finished with ${errors.length} error(s).`, 'error');
        els.downloadErrorsBtn.disabled = false;
        els.downloadErrorsBtn.onclick = () => downloadCSV(errors);
      } else {
        log('All done successfully.');
      }
    } catch (e) {
      log(String(e.message || e), 'error');
    } finally {
      els.runBtn.disabled = false;
      els.cancelBtn.disabled = true;
    }
  }

  els.runBtn.addEventListener('click', run);
})();
</script>
</body>
</html>
