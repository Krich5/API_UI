<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV → API Runner</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root { --bg:#0b1020; --card:#131a2a; --muted:#92a0b8; --fg:#e9edf5; --accent:#7dd3fc; --warn:#fbbf24; --err:#f87171; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg,#0b1020,#0a132a); color:var(--fg); }
    .wrap { max-width:1100px; margin:0 auto; padding:32px 20px 80px; }
    .title { font-size:clamp(24px,3vw,38px); font-weight:800; letter-spacing:.2px; }
    .sub { color:var(--muted); }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px; }
    .card { background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    label { display:block; font-size:12px; color:var(--muted); margin:6px 0 6px; }
    input, select, textarea { width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0e1525; color:var(--fg); padding:10px 12px; outline:none; }
    input[type="file"]{ padding:8px; }
    .row { display:flex; gap:10px; align-items:center; }
    .btn { background:linear-gradient(135deg,#22d3ee,#3b82f6); border:none; color:#06111d; font-weight:700; padding:10px 14px; border-radius:12px; cursor:pointer; }
    .btn.secondary { background:#0e1525; color:var(--fg); border:1px solid rgba(255,255,255,.1); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:12px; color:var(--muted); }
    .pill { display:inline-flex; gap:8px; align-items:center; border-radius:999px; padding:8px 10px; background:#0e1525; border:1px solid rgba(255,255,255,.08); }
    .progress { height:10px; background:#0e1525; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
    .bar { height:100%; background:linear-gradient(90deg,#22d3ee,#3b82f6); width:0%; transition:width .25s ease; }
    .log { height:240px; overflow:auto; background:#0e1525; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px; white-space:pre-wrap; }
    .danger { color:var(--err); }
    .warn { color:var(--warn); }
    a { color:var(--accent); }
  </style>
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;">
      <div>
        <div class="title">CSV → API Runner</div>
        <div class="sub">Upload a CSV, set your API details, and stream requests with retries, throttling, and an error report.</div>
      </div>
      <div class="pill">
        <span>Client‑side app · Host on GitHub Pages</span>
      </div>
    </div>

    <div class="grid" style="margin-top:18px;">
      <div class="card">
        <label>Base API URL</label>
        <input id="baseUrl" placeholder="https://api.example.com" />

        <div class="row">
          <div style="flex:1;">
            <label>Endpoint path</label>
            <input id="endpoint" placeholder="/v1/things" />
          </div>
          <div style="width:140px;">
            <label>Method</label>
            <select id="method">
              <option>POST</option>
              <option>PUT</option>
              <option>PATCH</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div style="flex:1;">
            <label>Org ID</label>
            <input id="orgId" placeholder="org_123..." />
            <div class="hint">Stored in your browser for convenience (localStorage). Not sent anywhere until requests run.</div>
          </div>
          <div style="flex:1;">
            <label>Org Header Name</label>
            <input id="orgHeader" placeholder="X-Org-Id" value="X-Org-Id" />
          </div>
        </div>

        <label>Bearer Token</label>
        <input id="token" type="password" placeholder="Paste your Bearer token" autocomplete="off" />
        <div class="hint">For security, token is <b>not</b> saved. It only lives in memory while the page is open.</div>

        <div class="row">
          <div style="flex:1;">
            <label>CSV</label>
            <input id="csvFile" type="file" accept=".csv" />
          </div>
          <div style="width:150px;">
            <label>Concurrency</label>
            <input id="concurrency" type="number" min="1" max="16" value="4" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <label class="row" style="gap:8px;align-items:center;">
            <input id="dryRun" type="checkbox" checked>
            <span>Dry‑run (parse & validate only)</span>
          </label>
          <label class="row" style="gap:8px;align-items:center;">
            <input id="stopOnError" type="checkbox">
            <span>Stop on first error</span>
          </label>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="runBtn" class="btn">Run</button>
          <button id="cancelBtn" class="btn secondary" disabled>Cancel</button>
          <button id="downloadErrorsBtn" class="btn secondary" disabled>Download errors CSV</button>
        </div>

        <div style="margin-top:14px;">
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div id="status" class="hint" style="margin-top:6px;">Idle</div>
        </div>
      </div>

      <div class="card">
        <label>Request payload mapping (optional JS)</label>
        <textarea id="mapper" rows="14" spellcheck="false">// row is an object of {columnName: value}
// Return the JSON body you want to send for each row
function mapRow(row) {
  // Example: rename CSV columns → API fields
  // return {
  //   name: row["Name"],
  //   sku: row["SKU"],
  //   price_cents: Math.round(parseFloat(row["PriceUSD"]) * 100)
  // };
  return row; // default: send the row as-is
}
        </textarea>
        <div class="hint">If your API needs a different shape, edit the function above. This runs in your browser.</div>

        <label style="margin-top:12px;">Console</label>
        <div id="log" class="log" aria-live="polite"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <b>Heads‑up on CORS & secrets:</b>
      <div class="hint">This is a front‑end only tool. Your API must allow browser requests from your GitHub Pages origin (CORS) and Bearer auth from the browser. If not, use a small serverless proxy (Netlify/Vercel/Cloudflare Workers) to keep the token secret and add CORS.
      </div>
    </div>
  </div>

<script>
(function() {
  const els = {
    baseUrl: document.getElementById('baseUrl'),
    endpoint: document.getElementById('endpoint'),
    method: document.getElementById('method'),
    orgId: document.getElementById('orgId'),
    orgHeader: document.getElementById('orgHeader'),
    token: document.getElementById('token'),
    csvFile: document.getElementById('csvFile'),
    concurrency: document.getElementById('concurrency'),
    dryRun: document.getElementById('dryRun'),
    stopOnError: document.getElementById('stopOnError'),
    runBtn: document.getElementById('runBtn'),
    cancelBtn: document.getElementById('cancelBtn'),
    downloadErrorsBtn: document.getElementById('downloadErrorsBtn'),
    mapper: document.getElementById('mapper'),
    bar: document.getElementById('bar'),
    status: document.getElementById('status'),
    log: document.getElementById('log'),
  };
  let abortFlag = false;
  let errors = [];

  // Persist orgId between sessions.
  try {
    const savedOrg = localStorage.getItem('csv_api_org');
    if (savedOrg) els.orgId.value = savedOrg;
    els.orgId.addEventListener('input', () => {
      localStorage.setItem('csv_api_org', els.orgId.value || '');
    });
  } catch {}

  function log(msg, type) {
    const line = document.createElement('div');
    if (type === 'error') line.classList.add('danger');
    if (type === 'warn') line.classList.add('warn');
    line.textContent = msg;
    els.log.appendChild(line);
    els.log.scrollTop = els.log.scrollHeight;
  }

  function setProgress(done, total) {
    const pct = total ? Math.round((done/total) * 100) : 0;
    els.bar.style.width = pct + '%';
    els.status.textContent = `${done}/${total} (${pct}%)`;
  }

  function downloadCSV(rows, name = 'errors.csv') {
    if (!rows.length) return;
    const headers = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
    const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? '').replace(/^"|"$/g,'')).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
  }

  function compileMapper(fnText) {
    try {
      // eslint-disable-next-line no-new-func
      const fn = new Function(fnText + '\n; return mapRow;')();
      if (typeof fn !== 'function') throw new Error('mapRow is not a function');
      return fn;
    } catch (e) {
      throw new Error('Mapper error: ' + e.message);
    }
  }

  async function sendRow({row, idx, cfg, mapRow}) {
    const url = cfg.baseUrl.replace(/\/$/,'') + '/' + cfg.endpoint.replace(/^\//,'');
    const body = JSON.stringify(mapRow(row));
    const headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${cfg.token}`,
    };
    if (cfg.orgId && cfg.orgHeader) headers[cfg.orgHeader] = cfg.orgId;

    const maxRetries = 4;
    const baseDelay = 500; // ms

    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      if (abortFlag) throw new Error('Cancelled');
      try {
        const res = await fetch(url, {
          method: cfg.method,
          headers,
          body,
        });
        const isJSON = res.headers.get('content-type')?.includes('application/json');
        const text = await res.text();
        const data = isJSON ? (JSON.parse(text || '{}')) : text;
        if (!res.ok) {
          const err = new Error(`HTTP ${res.status} ${res.statusText}`);
          err.response = { status: res.status, body: data };
          throw err;
        }
        return { ok: true, data };
      } catch (e) {
        const status = e?.response?.status || 0;
        const retriable = status === 0 || status >= 500 || status === 429;
        if (attempt < maxRetries && retriable) {
          const delay = baseDelay * Math.pow(2, attempt) + Math.random()*200;
          log(`Row ${idx+1}: retrying after ${Math.round(delay)}ms due to ${e.message || e}`, 'warn');
          await new Promise(r => setTimeout(r, delay));
          continue;
        }
        throw e;
      }
    }
  }

  async function run() {
    errors = [];
    abortFlag = false;
    els.runBtn.disabled = true;
    els.cancelBtn.disabled = false;
    els.downloadErrorsBtn.disabled = true;
    els.log.textContent = '';
    setProgress(0, 0);

    try {
      const cfg = {
        baseUrl: els.baseUrl.value.trim(),
        endpoint: els.endpoint.value.trim(),
        method: els.method.value,
        orgId: els.orgId.value.trim(),
        orgHeader: els.orgHeader.value.trim(),
        token: els.token.value.trim(),
        concurrency: Math.max(1, Math.min(16, parseInt(els.concurrency.value || '4',10))),
        dryRun: els.dryRun.checked,
        stopOnError: els.stopOnError.checked,
      };

      if (!cfg.baseUrl || !cfg.endpoint) throw new Error('Base URL and endpoint are required.');
      if (!cfg.dryRun && !cfg.token) throw new Error('Bearer token is required when not in dry‑run.');
      const file = els.csvFile.files?.[0];
      if (!file) throw new Error('Please select a CSV file.');

      const mapRow = compileMapper(els.mapper.value);

      const rows = await new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data),
          error: (err) => reject(err),
        });
      });

      const total = rows.length;
      if (!total) throw new Error('Your CSV appears to be empty.');
      log(`Parsed ${total} rows.`);
      setProgress(0, total);

      if (cfg.dryRun) {
        // Run mapper once to validate.
        try { mapRow(rows[0]); } catch(e) { throw new Error('Test mapping failed: ' + e.message); }
        log('Dry‑run mode: no network calls will be made. Disable Dry‑run to send requests.', 'warn');
        setProgress(total, total);
        els.runBtn.disabled = false;
        els.cancelBtn.disabled = true;
        return;
      }

      let done = 0;
      const queue = rows.map((row, idx) => ({row, idx}));

      async function worker(id) {
        while(queue.length && !abortFlag) {
          const item = queue.shift();
          if (!item) break;
          try {
            const res = await sendRow({ ...item, cfg, mapRow });
            log(`Row ${item.idx+1}: ✓ success`);
          } catch (e) {
            const status = e?.response?.status || '';
            const body = e?.response?.body;
            const msg = `Row ${item.idx+1}: ✗ error ${e.message}`;
            log(msg, 'error');
            errors.push({ row_number: item.idx+1, error: e.message, status, body: typeof body === 'string' ? body : JSON.stringify(body), ...item.row });
            if (cfg.stopOnError) { abortFlag = true; break; }
          } finally {
            done++; setProgress(done, total);
          }
        }
      }

      const workers = Array.from({length: cfg.concurrency}, (_, i) => worker(i));
      await Promise.all(workers);

      if (abortFlag) log('Run cancelled.', 'warn');
      if (errors.length) {
        log(`Finished with ${errors.length} error(s).`, 'error');
        els.downloadErrorsBtn.disabled = false;
      } else {
        log('All done with no errors.');
      }
    } catch (e) {
      log(String(e.message || e), 'error');
    } finally {
      els.runBtn.disabled = false;
      els.cancelBtn.disabled = true;
    }
  }

  els.runBtn.addEventListener('click', run);
  els.cancelBtn.addEventListener('click', () => { abortFlag = true; els.cancelBtn.disabled = true; });
  els.downloadErrorsBtn.addEventListener('click', () => downloadCSV(errors));
})();
</script>
</body>
</html>
